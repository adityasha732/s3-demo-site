<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S3 Drive-style Demo (Password-protected Upload)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f1f3f4; font-family: "Segoe UI", Roboto, Arial, sans-serif; }
    .topbar { height:64px; background:white; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display:flex; align-items:center; padding:0 20px; }
    .sidebar { width:240px; min-height: calc(100vh - 64px); background: white; padding-top:16px; box-shadow: 1px 0 0 rgba(0,0,0,0.04); }
    .sidebar a { display:block; padding:12px 18px; color:#333; text-decoration:none; border-radius:6px; margin:4px 8px; }
    .sidebar a:hover { background:#f5f7f9; text-decoration:none; }
    .main { padding:24px; }
    .card-drive { border-radius:12px; padding:18px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .file-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:16px; margin-top:16px; }
    .file-tile { background:#fff; border-radius:8px; padding:12px; text-align:center; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    .file-list { margin-top:16px; }
    .logo-snap { height:42px; margin-right:12px; border-radius:6px; }
    .search-input { width:420px; max-width:60vw; }
    .btn-primary { background:#1a73e8; border:0; }
    .progress { height: 14px; border-radius: 8px; }
    .muted-small { color: #6b7280; font-size: .9rem; }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar d-flex align-items-center">
    <!-- If the image path is invalid it will hide automatically -->
    <img src="/mnt/data/fd9632f3-674f-43d7-8244-9007743e1f57.png" alt="logo" class="logo-snap" onerror="this.style.display='none'">
    <h5 class="mb-0 me-auto">S3 Drive Demo</h5>

    <input id="searchInput" class="form-control search-input me-3" placeholder="Search files..." />
    <button class="btn btn-outline-secondary me-2" onclick="alert('Search is demo-only')">Search</button>
    <div class="btn-group">
      <button class="btn btn-secondary">Sign in</button>
    </div>
  </div>

  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
      <a href="#" class="fw-bold">My Drive</a>
      <a href="#">Shared with me</a>
      <a href="#">Recent</a>
      <a href="#">Starred</a>
      <a href="#">Trash</a>
      <hr>
      <a href="#" id="btnUploadQuick" class="text-primary">+ New (Upload)</a>
    </div>

    <!-- Main content -->
    <div class="main flex-grow-1">
      <!-- Upload card -->
      <div class="card-drive">
        <div class="d-flex align-items-center">
          <div>
            <h4 class="mb-1">Upload (password-protected)</h4>
            <div class="muted-small">The page will request a presigned PUT URL from your backend (password required) and then upload directly to S3.</div>
          </div>
        </div>

        <div class="mt-3">
          <div class="row g-3 align-items-center">
            <div class="col-md-3">
              <input type="file" id="fileInput" class="form-control" />
            </div>

            <div class="col-md-3">
              <input type="password" id="uploadPassword" class="form-control" placeholder="Upload password" />
            </div>

            <div class="col-md-3">
              <select id="fileType" class="form-select" title="File type (optional)">
                <option value="auto">Auto-detect</option>
                <option value="image">Image</option>
                <option value="video">Video</option>
                <option value="doc">Document</option>
                <option value="app">App</option>
              </select>
            </div>

            <div class="col-md-3 d-grid">
              <button class="btn btn-primary" id="uploadBtn">Upload File (password)</button>
            </div>
          </div>

          <div class="mt-3">
            <div class="row g-3">
              <div class="col-md-8">
                <input type="text" id="manualPutUrl" class="form-control" placeholder="(Fallback) Paste presigned PUT URL here" />
                <div class="muted-small mt-1">If you don't have a backend, paste a presigned PUT URL generated by your Java app here and click Upload.</div>
              </div>
              <div class="col-md-4 d-grid">
                <button class="btn btn-outline-secondary" id="uploadManualBtn">Upload using pasted PUT URL</button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <div class="progress" style="display:none;" id="uploadProgressWrap"><div id="uploadProgress" class="progress-bar" style="width:0%"></div></div>
            <div id="uploadStatus" class="mt-2"></div>
          </div>
        </div>
      </div>

      <!-- Files area -->
      <div class="card-drive mt-4">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Files</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="viewList()">List</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="viewGrid()">Grid</button>
          </div>
        </div>

        <div id="gridView" class="file-grid" style="display:none;">
          <!-- sample tiles -->
          <div class="file-tile"> <div class="fs-4">üìÑ</div> <div class="mt-2">report.pdf</div> </div>
          <div class="file-tile"> <div class="fs-4">üñºÔ∏è</div> <div class="mt-2">photo.jpg</div> </div>
        </div>

        <div id="listView" class="file-list">
          <table class="table table-borderless">
            <thead class="text-muted small">
              <tr><th>Name</th><th>Size</th><th>Actions</th></tr>
            </thead>
            <tbody id="filesTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Download card -->
      <div class="card-drive mt-4">
        <h5>Download</h5>
        <div class="row g-3 mt-2">
          <div class="col-md-9">
            <input type="text" id="getUrl" class="form-control" placeholder="Paste presigned GET URL" />
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary" id="downloadBtn">Download File</button>
            <button class="btn btn-outline-secondary mt-2" id="getSignedBtn">Get Presigned GET (via API)</button>
          </div>
        </div>
        <div class="muted-small mt-2">If your API supports GET presign, the "Get Presigned GET" button will request a presigned GET for the selected file key.</div>
      </div>

    </div>
  </div>

<script>
/* ============================
   CONFIG - Set these values
   ============================ */
const API_BASE = ""; // <-- Set to your API base URL, e.g. https://abcd1234.execute-api.ap-south-1.amazonaws.com/prod
// The API must implement:
// POST /presign  (headers: x-upload-password)  body: { filename, contentType, kind }  -> returns { url, key }
// POST /presign-get (optional) body: { key } -> returns { url }
/* ============================ */

const demoFiles = []; // client-side file list (populated after successful uploads)

function renderList(){
  const tbody = document.getElementById('filesTableBody');
  tbody.innerHTML = '';
  demoFiles.forEach(f => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(f.name)}</td><td>${f.size}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="promptGetAndFill('${f.name}')">Get URL</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteLocal('${f.name}')">Remove</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
renderList();

function viewGrid(){ document.getElementById('gridView').style.display='grid'; document.getElementById('listView').style.display='none'; }
function viewList(){ document.getElementById('gridView').style.display='none'; document.getElementById('listView').style.display='block'; }

// utility to escape HTML text for table
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* -------- Upload logic (primary: use API presign) -------- */
document.getElementById('uploadBtn').addEventListener('click', async () => {
  const file = document.getElementById('fileInput').files[0];
  const pw = document.getElementById('uploadPassword').value.trim();
  const kind = document.getElementById('fileType').value;

  if (!file) return alert('Please select a file.');
  if (!API_BASE){
    return alert('No API configured. Either set API_BASE in the script or use the manual presigned URL field.');
  }
  if (!pw) return alert('Enter upload password.');

  const body = { filename: file.name, contentType: file.type || 'application/octet-stream', kind };
  try {
    const res = await fetch(API_BASE + '/presign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-upload-password': pw },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error('Presign failed: ' + txt);
    }
    const { url, key } = await res.json();
    await uploadToS3(url, file);
    demoFiles.unshift({ name: key, size: formatBytes(file.size) });
    renderList();
    showStatus('Upload finished: ' + key, true);
  } catch (err) {
    showStatus('Error: ' + err.message, false);
    console.error(err);
    alert('Upload error: ' + err.message);
  }
});

/* -------- Fallback manual PUT URL upload (if no API) -------- */
document.getElementById('uploadManualBtn').addEventListener('click', async () => {
  const file = document.getElementById('fileInput').files[0];
  const url = document.getElementById('manualPutUrl').value.trim();
  if (!file || !url) return alert('Choose file and paste a presigned PUT URL.');
  try {
    await uploadToS3(url, file);
    // derive key from URL (best-effort)
    const key = url.split('?')[0].split('/').slice(3).join('/');
    demoFiles.unshift({ name: key, size: formatBytes(file.size) });
    renderList();
    showStatus('Manual upload finished: ' + key, true);
  } catch (err) {
    showStatus('Error: ' + err.message, false);
    alert('Manual upload error: ' + err.message);
  }
});

/* -------- helper: upload file to S3 using PUT url with progress -------- */
async function uploadToS3(url, file) {
  showProgress(0);
  const xhr = new XMLHttpRequest();
  return new Promise((resolve, reject) => {
    xhr.open('PUT', url, true);
    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        showProgress(100);
        resolve();
      } else {
        reject(new Error('Upload failed: ' + xhr.status));
      }
    };
    xhr.onerror = () => reject(new Error('Network error during upload'));
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round(e.loaded / e.total * 100);
        showProgress(pct);
      }
    };
    xhr.send(file);
  });
}

function showProgress(pct){
  const wrap = document.getElementById('uploadProgressWrap');
  const bar = document.getElementById('uploadProgress');
  wrap.style.display = pct === 0 ? 'none' : 'block';
  bar.style.width = pct + '%';
  bar.textContent = pct + '%';
}

function showStatus(text, ok){
  const el = document.getElementById('uploadStatus');
  el.textContent = text;
  el.style.color = ok ? 'green' : 'red';
  setTimeout(()=>{ el.textContent = ''; }, 8000);
}

function formatBytes(bytes){
  if (!bytes) return '0 B';
  const sizes = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(bytes)/Math.log(1024));
  return Math.round(bytes/Math.pow(1024,i)) + ' ' + sizes[i];
}

/* -------- Download / GET presign helpers -------- */
document.getElementById('downloadBtn').addEventListener('click', () => {
  const url = document.getElementById('getUrl').value.trim();
  if (!url) return alert('Paste the presigned GET URL first.');
  window.open(url, '_blank');
});

// optional: call API to get presigned GET for a key (requires API support)
document.getElementById('getSignedBtn').addEventListener('click', async () => {
  if (!API_BASE) return alert('No API configured for GET presign.');
  const key = prompt('Enter file key to presign (example: uploads/12345-file.jpg):');
  if (!key) return;
  try {
    const res = await fetch(API_BASE + '/presign-get', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key })
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t);
    }
    const { url } = await res.json();
    document.getElementById('getUrl').value = url;
    alert('Presigned GET URL placed in input. Click Download.');
  } catch (err) {
    alert('Error getting presigned GET: ' + err.message);
  }
});

/* -------- small helpers for demo file actions -------- */
function promptGetAndFill(key){
  if (API_BASE) {
    if (!confirm('Would you like to request a presigned GET URL from the backend for: ' + key + '?')) return;
    (async ()=>{
      try {
        const res = await fetch(API_BASE + '/presign-get', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        if (!res.ok) { const t = await res.text(); throw new Error(t); }
        const { url } = await res.json();
        document.getElementById('getUrl').value = url;
        alert('Presigned GET placed in the input.');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    })();
  } else {
    const sample = prompt('Paste the presigned GET URL for: ' + key + '\n(Use your Java app to generate it)');
    if (sample) document.getElementById('getUrl').value = sample;
  }
}

function deleteLocal(key){
  if (!confirm('Remove ' + key + ' from the page? This does not delete it in S3.')) return;
  const idx = demoFiles.findIndex(d => d.name === key);
  if (idx >= 0) demoFiles.splice(idx, 1);
  renderList();
}

/* ======= Utility: quick upload button behaviour ======= */
document.getElementById('btnUploadQuick').addEventListener('click', () => {
  document.getElementById('fileInput').scrollIntoView({behavior:'smooth'});
  document.getElementById('fileInput').focus();
});

/* ======= End of script ======= */
</script>

</body>
</html>
