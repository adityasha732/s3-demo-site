<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CloudVault — S3 Drive (Cognito + Email OTP)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --accent:#1a73e8; --muted:#6b7280; }
    body { font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f4f6f8; margin:0; }
    .topbar{height:64px;background:#fff;border-bottom:1px solid #eef2f6;display:flex;align-items:center;padding:0 20px}
    .logo{height:40px;margin-right:12px;border-radius:6px;object-fit:cover;cursor:pointer}
    .sidebar{width:220px;background:#fff;padding:16px;border-right:1px solid #eef2f6;min-height:calc(100vh - 64px)}
    .card-panel{border-radius:12px;padding:18px;background:#fff;box-shadow:0 6px 18px rgba(12,26,44,0.04)}
    .muted{color:var(--muted)}
    .small{font-size:.9rem}
    .grid-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .list-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}
    .progress { background:#e9eef8; height:18px; border-radius:10px; overflow:visible; }
    .progress-bar { background: var(--accent); transition: width 200ms linear; height:100%; }
    #progressWrap { position:relative; }
    #progressLabel { position:relative; margin-top:6px; text-align:center; font-weight:600; color:#fff; margin-left:auto; margin-right:auto; width:100%; transform: translateY(-28px); pointer-events:none; }
    #siteTitle { cursor:pointer; user-select: none; }
    .meta-muted { color:#94a3b8; font-size:.85rem; }
  </style>
</head>
<body>
  <div class="topbar">
    <img id="topLogo" src="" class="logo" alt="CloudVault logo" style="display:none">
    <h5 id="siteTitle" class="mb-0 me-3">CloudVault</h5>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <div id="userInfo" class="muted small me-2"></div>
    </div>
  </div>

  <div class="d-flex">
    <aside class="sidebar">
      <a href="#" class="d-block mb-2 fw-bold">My Drive</a>
      <div class="muted small">Demo: Cognito (frontend) → S3 + Email OTP</div>
      <hr>
      <div class="mt-2"><small class="muted">Recipient email (change if needed):</small>
        <input id="recipientEmail" class="form-control form-control-sm mt-1" value="shaaditya87@gmail.com">
      </div>
    </aside>

    <main class="flex-grow-1 p-4">
      <div class="card-panel">
        <h5 class="m-0">Upload (Cognito → S3 + Email OTP)</h5>
        <div class="muted small">Select file, optionally use OTP prefix. After upload the OTP will be emailed to the recipient.</div>

        <div class="row g-2 align-items-center mt-3">
          <div class="col-auto">
            <input id="fileInput" type="file" class="form-control form-control-sm" />
          </div>
          <div class="col-auto">
            <input id="keyInput" type="text" class="form-control form-control-sm" placeholder="storage key (optional)">
          </div>
          <div class="col-auto">
            <label class="small"><input id="otpToggle" type="checkbox"> Use OTP prefix</label>
          </div>
          <div class="col-auto">
            <label class="small"><input id="encryptToggle" type="checkbox"> Encrypt with OTP</label>
          </div>
          <div class="col-auto">
            <button id="uploadBtn" class="btn btn-sm" style="background:var(--accent);color:#fff">Upload</button>
          </div>
        </div>

        <div class="mt-3">
          <div id="progressWrap" style="display:none; margin-top:12px;">
            <div class="progress"><div id="progressBar" class="progress-bar" role="progressbar" style="width:0%;"></div></div>
            <div id="progressLabel">0%</div>
          </div>
          <div id="uploadMsg" class="small muted mt-2"></div>
        </div>
      </div>

      <div class="card-panel mt-4">
        <h5 class="m-0">Files (local demo cache)</h5>
        <div id="filesList" class="mt-3"></div>
      </div>

      <div class="card-panel mt-4">
        <h6 class="m-0">Download / Presigned GET</h6>
        <div class="row g-2 mt-2">
          <div class="col-md-8"><input id="getUrlInput" class="form-control form-control-sm" placeholder="Presigned GET appears here"></div>
          <div class="col-md-4 d-grid">
            <button id="openGetBtn" class="btn btn-sm btn-primary">Open URL</button>
            <button id="reqGetBtn" class="btn btn-sm btn-outline-secondary mt-2">Generate GET (browser)</button>
          </div>
        </div>
      </div>

    </main>
  </div>

<script type="module">
/* ================== CONFIG (edit only if different) ================== */
const IDENTITY_POOL_ID = "ap-south-1:a1c00d3f-80ab-4b77-a42d-f44f5493ee0a";
const BUCKET = "my-storage-project";
const REGION = "ap-south-1";
/* Backend that will send OTP emails (local test) */
const BACKEND_BASE = "http://localhost:3000"; // change to deployed URL when available
/* =================================================================== */

/* AWS SDK imports (ESM) */
import { fromCognitoIdentityPool } from "https://unpkg.com/@aws-sdk/credential-provider-cognito-identity?module";
import { S3Client, PutObjectCommand, GetObjectCommand } from "https://unpkg.com/@aws-sdk/client-s3?module";
import { getSignedUrl } from "https://unpkg.com/@aws-sdk/s3-request-presigner?module";

/* Build S3 client */
const s3Client = new S3Client({
  region: REGION,
  credentials: fromCognitoIdentityPool({
    clientConfig: { region: REGION },
    identityPoolId: IDENTITY_POOL_ID
  })
});

/* Helpers */
function nowMs(){ return Date.now(); }
function generateOtp(len=6){ return Math.floor(Math.random()*Math.pow(10,len)).toString().padStart(len,"0"); }
function s3KeyFor(otp,name){ return `otp/${otp}/${name}`; }
function setProgress(p){ p = Math.max(0,Math.min(100,Math.round(p))); document.getElementById('progressWrap').style.display = p===0 ? 'none' : 'block'; document.getElementById('progressBar').style.width = p + '%'; document.getElementById('progressLabel').textContent = p + '%'; }
function setMessage(t,ok=true){ const e = document.getElementById('uploadMsg'); e.textContent=t; e.style.color = ok ? 'green' : 'crimson'; setTimeout(()=>{ e.textContent=''; },7000); }

/* WebCrypto derived key helpers (AES-GCM) */
async function deriveKeyFromOtp(otp){
  const enc = new TextEncoder();
  const base = await crypto.subtle.importKey("raw", enc.encode(otp), { name:"PBKDF2" }, false, ["deriveKey"]);
  return crypto.subtle.deriveKey({ name:"PBKDF2", salt: enc.encode("cloudvault-demo-salt"), iterations:100000, hash:"SHA-256" }, base, { name:"AES-GCM", length:256 }, false, ["encrypt","decrypt"]);
}
async function encryptBlobWithOtp(blob, otp){
  const key = await deriveKeyFromOtp(otp);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ab = await blob.arrayBuffer();
  const ct = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, ab);
  const combined = new Uint8Array(iv.byteLength + ct.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(ct), iv.byteLength);
  return new Blob([combined], { type: "application/octet-stream" });
}
async function decryptArrayBuffer(ivPlusCipher, otp){
  const key = await deriveKeyFromOtp(otp);
  const data = new Uint8Array(ivPlusCipher);
  const iv = data.slice(0,12);
  const cipher = data.slice(12);
  const plain = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, cipher);
  return plain;
}

/* Email backend helper */
async function emailOtpToRecipient(backendBase, email, otp, key){
  try {
    const resp = await fetch(backendBase + '/send-otp', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, otp, key })
    });
    const j = await resp.json();
    if(resp.ok) return { ok:true, json:j };
    return { ok:false, json:j };
  } catch(e){ console.error('send-otp error',e); return { ok:false, error:e }; }
}

/* UI state + persistence (local only) */
let files = [];
const STORE_KEY = 'cv_files_v1';
function saveLocal(){ localStorage.setItem(STORE_KEY, JSON.stringify(files)); renderFiles(); }
function loadLocal(){ const r = localStorage.getItem(STORE_KEY); if(!r) return false; try{ files = JSON.parse(r); return true; }catch(e){return false;} }
loadLocal();

/* Render */
function renderFiles(){
  const listArea = document.getElementById('filesList');
  listArea.innerHTML = '';
  if(files.length===0) { listArea.innerHTML = '<div class="muted">No files</div>'; return; }
  for(const f of files){
    const div = document.createElement('div'); div.className='list-row';
    div.innerHTML = `<div><strong>${f.name}</strong><div class="muted small">${f.key}</div></div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    const getBtn = document.createElement('button'); getBtn.className='btn btn-sm btn-outline-primary'; getBtn.textContent='Get URL';
    getBtn.onclick = ()=> requestGetPresign(f.key).then(url=>{ if(url) { document.getElementById('getUrlInput').value = url; alert('Presigned URL placed in input'); }});
    const openBtn = document.createElement('button'); openBtn.className='btn btn-sm btn-outline-secondary'; openBtn.textContent='Open';
    openBtn.onclick = ()=> { if(f.url) window.open(f.url,'_blank'); else requestGetPresign(f.key).then(url=>window.open(url,'_blank')); };
    right.appendChild(getBtn); right.appendChild(openBtn);
    div.appendChild(right); listArea.appendChild(div);
  }
}

/* Upload handler */
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  const fileInput = document.getElementById('fileInput');
  if(!fileInput.files || fileInput.files.length===0) return alert('Pick a file');
  const file = fileInput.files[0];
  const requestedKey = (document.getElementById('keyInput').value || '').trim();
  const useOtp = document.getElementById('otpToggle').checked;
  const wantEncrypt = document.getElementById('encryptToggle').checked;
  const recipientEmail = (document.getElementById('recipientEmail').value || '').trim();

  let otp = null;
  if(useOtp) otp = generateOtp(6);
  else if(wantEncrypt) otp = generateOtp(6); // encryption needs OTP too (we derive key from an otp)

  // determine key
  let finalKey;
  if(requestedKey) finalKey = requestedKey;
  else if(useOtp) finalKey = s3KeyFor(otp, file.name + (wantEncrypt ? '.enc':'' ));
  else finalKey = file.name + (wantEncrypt ? '.enc' : '');

  try {
    setProgress(0); setMessage('Preparing file...', true);

    let bodyToUpload = file;
    let contentType = file.type || 'application/octet-stream';
    if(wantEncrypt){
      bodyToUpload = await encryptBlobWithOtp(file, otp);
      contentType = 'application/octet-stream';
    }

    setMessage('Uploading to S3...', true);
    // upload using AWS SDK PutObjectCommand
    const putCmd = new PutObjectCommand({ Bucket: BUCKET, Key: finalKey, Body: bodyToUpload, ContentType: contentType });
    await s3Client.send(putCmd);

    // generate presigned GET for convenience
    let presigned = null;
    try { presigned = await getSignedUrl(s3Client, new GetObjectCommand({ Bucket: BUCKET, Key: finalKey }), { expiresIn: 60 * 10 }); } catch(e){ console.warn('presign-get failed', e); }

    // add to local files
    files.unshift({ key: finalKey, name: finalKey.split('/').slice(-1)[0], size: bodyToUpload.size || file.size, contentType, modified: nowMs(), url: presigned });
    saveLocal();
    setProgress(100);
    setMessage('Upload complete: ' + finalKey, true);

    // EMAIL OTP if we generated one
    if(otp){
      if(!recipientEmail) {
        alert('Upload complete. OTP: ' + otp + '\nNo recipient email configured; copy the OTP.');
      } else {
        const r = await emailOtpToRecipient(BACKEND_BASE, recipientEmail, otp, finalKey);
        if(r.ok) {
          alert('Upload complete — OTP emailed to ' + recipientEmail + '.');
        } else {
          console.warn('email OTP failed', r);
          alert('Upload complete. OTP: ' + otp + '\nBut email failed — copy the OTP and share manually.');
        }
      }
    }

    // cleanup inputs
    document.getElementById('fileInput').value = '';
    document.getElementById('keyInput').value = '';
    document.getElementById('otpToggle').checked = false;
    document.getElementById('encryptToggle').checked = false;

    renderFiles();
  } catch(err){
    console.error(err);
    setProgress(0);
    setMessage('Upload failed: ' + (err.message || err), false);
    alert('Upload failed: ' + (err.message || err));
  }
});

/* Presigned GET (browser) */
async function requestGetPresign(key){
  try {
    const presigned = await getSignedUrl(s3Client, new GetObjectCommand({ Bucket: BUCKET, Key: key }), { expiresIn: 60 * 10 });
    return presigned;
  } catch(e){ console.error('get presign failed', e); alert('Could not generate presigned GET: ' + e.message); return null; }
}

/* open/get buttons */
document.getElementById('openGetBtn').addEventListener('click', ()=>{ const u = document.getElementById('getUrlInput').value.trim(); if(!u) return alert('Paste presigned GET URL'); window.open(u,'_blank'); });
document.getElementById('reqGetBtn').addEventListener('click', async ()=>{ const k = prompt('Enter key to presign (e.g. otp/123456/file.ext):'); if(!k) return; const url = await requestGetPresign(decodeURIComponent(k)); if(url) document.getElementById('getUrlInput').value = url; });

/* initial render */
renderFiles();

</script>
</body>
</html>
