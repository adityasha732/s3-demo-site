<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S3 Drive Demo â€” Shinchan Progress</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{--accent:#1a73e8}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f4f6f8}
    .topbar{height:64px;background:#fff;border-bottom:1px solid #eef2f6;display:flex;align-items:center;padding:0 20px}
    .logo{height:42px;margin-right:12px;border-radius:6px}
    .sidebar{width:220px;background:#fff;padding:16px;border-right:1px solid #eef2f6;min-height:calc(100vh - 64px)}
    .card-panel{border-radius:12px;padding:18px;background:#fff;box-shadow:0 6px 18px rgba(12,26,44,0.04)}
    .file-tile{border-radius:8px;padding:12px;background:#fbfdff;border:1px solid #eef4ff}
    .muted{color:#6b7280}
    .small{font-size:.9rem}
    .actions button{margin-right:6px}
    .star{cursor:pointer}
    .grid-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .list-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9}

    /* progress + shinchan */
    .progress { background:#e9eef8; height:18px; border-radius:10px; overflow:visible; }
    .progress-bar { background: var(--accent); transition: width 200ms linear; height:100%; }
    #shinchan { position:absolute; top:-92px; left:0%; width:120px; transform:translateX(-50%); transition:left 160ms linear, transform 160ms linear; display:none; pointer-events:none; will-change:left, transform; }
    #progressWrap { position:relative; }
    #progressLabel { position:relative; margin-top:6px; text-align:center; font-weight:600; color:#fff; margin-left:auto; margin-right:auto; width:100%; transform: translateY(-28px); pointer-events:none; }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="/mnt/data/300d1f38-be30-4b16-847f-e026d36997bf.png" class="logo" alt="logo" onerror="this.style.display='none'">
    <h5 class="mb-0 me-3">S3 Drive Demo</h5>
    <input id="search" class="form-control form-control-sm me-2" placeholder="Search files (client-side)" style="width:360px;max-width:40vw">
    <button id="searchBtn" class="btn btn-sm btn-outline-secondary me-3">Search</button>
    <div class="ms-auto d-flex gap-2">
      <button id="signBtn" class="btn btn-sm btn-secondary">Sign in</button>
    </div>
  </div>

  <div class="d-flex">
    <aside class="sidebar">
      <a href="#" class="d-block mb-2 fw-bold">My Drive</a>
      <a href="#" class="d-block muted small" data-view="all">All files</a>
      <a href="#" class="d-block muted small" data-view="recent">Recent</a>
      <a href="#" class="d-block muted small" data-view="starred">Starred</a>
      <a href="#" class="d-block muted small" data-view="trash">Trash</a>
      <hr>
      <a href="#" id="quickUpload" class="text-primary">+ New (Upload)</a>
    </aside>

    <main class="flex-grow-1 p-4">
      <!-- Upload Panel -->
      <div class="card-panel">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h5 class="m-0">Upload (presigned PUT)</h5>
            <div class="muted small">This frontend requests presigned PUT URLs from your backend, uploads directly to S3, then notifies your backend to record metadata. If you don't have an API, paste a presigned PUT URL in the fallback field.</div>
          </div>
        </div>

        <div class="row g-2 align-items-center mt-3">
          <div class="col-auto">
            <input id="fileInput" type="file" class="form-control form-control-sm">
          </div>
          <div class="col-auto">
            <input id="keyInput" type="text" class="form-control form-control-sm" placeholder="storage key (optional)">
          </div>
          <div class="col-auto">
            <input id="pwInput" type="password" class="form-control form-control-sm" placeholder="upload password">
          </div>
          <div class="col-auto">
            <button id="uploadBtn" class="btn btn-sm" style="background:var(--accent);color:#fff">Upload</button>
          </div>
        </div>

        <div class="row g-2 mt-3">
          <div class="col-md-8">
            <input id="manualPut" class="form-control form-control-sm" placeholder="(Fallback) paste presigned PUT URL here">
            <div class="muted small mt-1">If you have a Java app that generates a presigned PUT URL, paste it here and click "Upload using PUT".</div>
          </div>
          <div class="col-md-4 d-grid">
            <button id="uploadManual" class="btn btn-outline-secondary btn-sm">Upload using pasted PUT URL</button>
          </div>
        </div>

        <div class="mt-3">
          <!-- PROGRESS + SHINCHAN: This container contains the progress bar and the animated (or static) Shinchan image above it -->
          <div id="progressWrap" style="display:none; margin-top:12px;">
            <div style="position:relative;">
              <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%;"></div>
              </div>

              <!-- Shinchan image placed absolutely above the bar; uses the cropped image path you provided -->
              <img id="shinchan" src="/mnt/data/A_cropped_user_interface_screenshot_features_an_up.png" alt="Shinchan">
            </div>

            <!-- Percent label centered visually inside the bar (optional) -->
            <div id="progressLabel">0%</div>
          </div>

          <div id="uploadMsg" class="small muted mt-2"></div>
        </div>
      </div>

      <!-- Files Panel -->
      <div class="card-panel mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Files</h5>
          <div>
            <button id="listViewBtn" class="btn btn-sm btn-outline-secondary me-1">List</button>
            <button id="gridViewBtn" class="btn btn-sm btn-outline-secondary">Grid</button>
          </div>
        </div>

        <div id="listArea">
          <div id="filesList"></div>
        </div>

        <div id="gridArea" style="display:none" class="mt-3">
          <div id="filesGrid" class="grid-wrap"></div>
        </div>
      </div>

      <!-- Download Panel -->
      <div class="card-panel mt-4">
        <h6 class="m-0">Download / Get Presigned GET</h6>
        <div class="row g-2 mt-2">
          <div class="col-md-8">
            <input id="getUrlInput" class="form-control form-control-sm" placeholder="Paste presigned GET URL (or the output will be placed here)">
          </div>
          <div class="col-md-4 d-grid">
            <button id="openGetBtn" class="btn btn-sm btn-primary">Open URL</button>
            <button id="reqGetBtn" class="btn btn-sm btn-outline-secondary mt-2">Request Presigned GET from API</button>
          </div>
        </div>
        <div class="muted small mt-2">If your backend implements /presign-get, it will return a presigned GET for a requested key.</div>
      </div>

    </main>
  </div>

<script>
// =========== Config - change to match your backend ==============
const API_BASE = ''; // e.g. 'https://your-backend.example.com'
// Expected endpoints:
// POST  ${API_BASE}/presign        { filename, contentType, key? }  -> { url, key }
// POST  ${API_BASE}/presign-get    { key } -> { url }
// POST  ${API_BASE}/files          { key, name, size, contentType } -> store metadata
// DELETE ${API_BASE}/files/:key    -> delete object & metadata
// ==============================================================

// Simple client-side model for files (used for demo + UI rendering)
let files = [];
let renderMode = 'list';

// Helpers
function escapeHtml(s){ return String(s||'').replace(/[&<>'"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'" :'&#39;'}[c]||c)); }
function humanSize(n){ if(!n) return '0 B'; const units=['B','KB','MB','GB']; let i=0; while(n>=1024&&i<units.length-1){ n/=1024; i++; } return Math.round(n*10)/10 + ' ' + units[i]; }

// UI references
const fileInput = document.getElementById('fileInput');
const keyInput = document.getElementById('keyInput');
const pwInput = document.getElementById('pwInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadManual = document.getElementById('uploadManual');
const manualPut = document.getElementById('manualPut');
const uploadMsg = document.getElementById('uploadMsg');
const progressWrap = document.getElementById('progressWrap');
const progressBar = document.getElementById('progressBar');
const filesList = document.getElementById('filesList');
const filesGrid = document.getElementById('filesGrid');
const getUrlInput = document.getElementById('getUrlInput');
const shinEl = document.getElementById('shinchan');
const progressLabel = document.getElementById('progressLabel');

// Render functions
function renderFiles(){
  const q = (document.getElementById('search').value||'').toLowerCase().trim();
  const show = files.filter(f => !q || f.name.toLowerCase().includes(q) || f.key.toLowerCase().includes(q));

  // list
  filesList.innerHTML = '';
  if(show.length===0){ filesList.innerHTML = '<div class="muted">No files</div>'; }
  show.forEach(f=>{
    const div = document.createElement('div'); div.className='list-row';
    const left = document.createElement('div'); left.innerHTML = `<div><strong>${escapeHtml(f.name)}</strong><div class="muted small">${escapeHtml(f.key)}</div></div>`;
    const right = document.createElement('div'); right.innerHTML = `<div class="small muted">${humanSize(f.size)}</div>`;

    // actions
    const actions = document.createElement('div'); actions.className='actions';
    const getBtn = document.createElement('button'); getBtn.className='btn btn-sm btn-outline-primary me-1'; getBtn.textContent='Get URL';
    getBtn.onclick = ()=> requestGetPresign(f.key);
    const dlBtn = document.createElement('button'); dlBtn.className='btn btn-sm btn-outline-secondary me-1'; dlBtn.textContent='Open'; dlBtn.onclick = ()=> openPresigned(f.url || f.key);
    const starBtn = document.createElement('button'); starBtn.className='btn btn-sm btn-outline-warning me-1'; starBtn.textContent='â˜…'; starBtn.onclick = ()=> toggleStar(f.key);
    const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-outline-danger'; delBtn.textContent='Delete'; delBtn.onclick = ()=> deleteFile(f.key);
    actions.append(getBtn, dlBtn, starBtn, delBtn);
    right.appendChild(actions);

    div.append(left,right);
    filesList.appendChild(div);
  });

  // grid
  filesGrid.innerHTML='';
  show.forEach(f=>{
    const t = document.createElement('div'); t.className='file-tile';
    t.innerHTML = `<div style="font-size:28px">ðŸ“„</div><div style="margin-top:8px"><strong>${escapeHtml(f.name)}</strong></div><div class="muted small">${humanSize(f.size)}</div>
      <div style="margin-top:8px"><button class='btn btn-sm btn-outline-primary' onclick="requestGetPresign('${encodeURIComponent(f.key)}')">Get URL</button></div>`;
    filesGrid.appendChild(t);
  });
}

// Toggle view buttons
document.getElementById('listViewBtn').addEventListener('click', ()=>{ document.getElementById('listArea').style.display='block'; document.getElementById('gridArea').style.display='none'; renderMode='list'; });
document.getElementById('gridViewBtn').addEventListener('click', ()=>{ document.getElementById('listArea').style.display='none'; document.getElementById('gridArea').style.display='block'; renderMode='grid'; });

// Basic actions (client-only simulation where backend not configured)
function toggleStar(key){ const it = files.find(x=>x.key===key); if(!it) return; it.star = !it.star; renderFiles(); }
function deleteFile(key){ if(!confirm('Delete '+key+'? This demo will simulate removal only.')) return; const idx = files.findIndex(x=>x.key===key); if(idx>=0) files.splice(idx,1); renderFiles(); }
function openPresigned(url){ if(!url) return alert('No URL available for this file. Use Get URL to request a presigned GET from the backend.'); window.open(url, '_blank'); }

// Search
document.getElementById('searchBtn').addEventListener('click', ()=> renderFiles());
document.getElementById('search').addEventListener('keydown', e=>{ if(e.key==='Enter') renderFiles(); });

// -------- UPLOAD FLOW ---------
// upload button: request presign -> upload to presign URL (PUT with progress) -> notify backend (optional)
uploadBtn.addEventListener('click', async ()=>{
  const file = fileInput.files[0];
  if(!file) return alert('Pick a file to upload');
  const key = keyInput.value.trim() || file.name;
  const pw = pwInput.value.trim();
  if(API_BASE && !pw) return alert('Enter upload password');

  try{
    setProgress(0);
    setMessage('Requesting presigned URL...', true);
    let presignUrl = manualPut.value.trim();
    let realKey = key;
    if(API_BASE){
      const resp = await fetch(API_BASE + '/presign', { method:'POST', headers: {'Content-Type':'application/json', 'x-upload-password': pw }, body: JSON.stringify({ filename:file.name, contentType:file.type, key }) });
      if(!resp.ok) throw new Error('Presign request failed: ' + resp.status);
      const j = await resp.json(); presignUrl = j.url; realKey = j.key || key;
    }
    if(!presignUrl) throw new Error('No presigned URL available');

    // upload via PUT with progress (xhrUpload will call setProgress)
    await xhrUpload(presignUrl, file);

    // notify backend to index the file (optional)
    if(API_BASE){ await fetch(API_BASE + '/files', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key: realKey, name: file.name, size: file.size, contentType: file.type }) }); }

    files.unshift({ key: realKey, name: file.name, size: file.size, contentType: file.type, url: API_BASE ? undefined : presignUrl });
    setMessage('Upload finished: ' + realKey, true);
    setProgress(100);
    renderFiles();

    // reset inputs
    fileInput.value=''; keyInput.value=''; pwInput.value=''; manualPut.value='';
  }catch(err){
    console.error(err);
    setMessage('Upload error: '+err.message,false);
    setProgress(0);
  }
});

// Manual upload using pasted PUT URL
uploadManual.addEventListener('click', async ()=>{
  const file = fileInput.files[0]; const url = manualPut.value.trim(); if(!file || !url) return alert('Select file and paste a presigned PUT URL');
  try{ setMessage('Uploading via pasted PUT URL...'); await xhrUpload(url,file); files.unshift({ key: url.split('?')[0].split('/').slice(3).join('/'), name: file.name, size: file.size, contentType: file.type, url }); renderFiles(); setMessage('Manual upload finished',true); }catch(e){ setMessage('Manual upload error: '+e.message,false); }
});

// xhr upload with progress
function xhrUpload(url, file){ return new Promise((resolve,reject)=>{
  const xhr = new XMLHttpRequest(); xhr.open('PUT', url, true);
  xhr.onload = ()=>{ if(xhr.status>=200 && xhr.status<300) resolve(); else reject(new Error('Upload failed: '+xhr.status)); };
  xhr.onerror = ()=>reject(new Error('Network error'));
  xhr.upload.onprogress = e=>{ if(e.lengthComputable) setProgress(Math.round(e.loaded / e.total * 100)); };
  xhr.send(file);
}); }

// New setProgress implementation that moves Shinchan across the bar
function setProgress(pct) {
  pct = Math.max(0, Math.min(100, Math.round(pct)));
  // show/hide container & image
  if (pct === 0) {
    progressWrap.style.display = 'none';
    shinEl.style.display = 'none';
  } else {
    progressWrap.style.display = 'block';
    shinEl.style.display = 'block';
  }

  // update bar width and label
  progressBar.style.width = pct + '%';
  progressLabel.textContent = pct + '%';

  // move image horizontally to match progress
  // keep Shinchan inside the bar area (3% - 97%)
  const leftPct = Math.max(3, Math.min(97, pct));
  shinEl.style.left = leftPct + '%';

  // small bobbing motion while uploading for movement effect
  if (pct < 100) {
    shinEl.style.transform = `translateX(-50%) translateY(${Math.sin(Date.now() / 140) * 2}px)`;
  } else {
    shinEl.style.transform = `translateX(-50%) translateY(0px)`;
    // keep visible briefly at 100%
    setTimeout(()=>{ /* shinEl.style.display = 'none'; */ }, 1200);
  }
}

function setMessage(text, ok=true){ uploadMsg.textContent = text; uploadMsg.style.color = ok ? 'green' : 'crimson'; setTimeout(()=>{ uploadMsg.textContent=''; }, 7000); }

// -------- Request presigned GET from API (if configured) --------
async function requestGetPresign(key){
  const decoded = decodeURIComponent(key);
  if(!API_BASE) return prompt('No API configured. Paste your presigned GET URL for '+decoded+' (manual):');
  try{
    const resp = await fetch(API_BASE + '/presign-get', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key: decoded }) });
    if(!resp.ok) throw new Error('GET presign failed: '+resp.status);
    const j = await resp.json(); getUrlInput.value = j.url; alert('Presigned GET placed in the input');
  }catch(e){ alert('Error requesting GET presign: '+e.message); }
}

// open URL button
document.getElementById('openGetBtn').addEventListener('click', ()=>{
  const u = getUrlInput.value.trim(); if(!u) return alert('Paste a presigned GET URL'); window.open(u,'_blank');
});
document.getElementById('reqGetBtn').addEventListener('click', async ()=>{ const k = prompt('Enter key to presign (e.g. uploads/abc.jpg):'); if(!k) return; await requestGetPresign(encodeURIComponent(k)); });

// initial demo files (if any)
files = [ { key:'images/test.jpg', name:'images/test.jpg', size:24567 }, { key:'docs/report.pdf', name:'docs/report.pdf', size:120345 } ];
renderFiles();

</script>
</body>
</html>
