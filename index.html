<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CloudVault â€” S3 Drive</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root { --accent:#1a73e8; --muted:#6b7280; }
body { font-family: system-ui; background:#f4f6f8; margin:0; }
.topbar{height:64px;background:#fff;border-bottom:1px solid #eef2f6;display:flex;align-items:center;padding:0 20px}
.logo{height:40px;margin-right:12px;border-radius:6px}
.sidebar{width:220px;background:#fff;padding:16px;border-right:1px solid #eef2f6}
.card-panel{border-radius:12px;padding:18px;background:#fff;box-shadow:0 6px 18px rgba(12,26,44,0.04)}
.muted{color:#6b7280}
.progress{height:18px}
</style>
</head>

<body>

<div class="topbar">
  <img src="asset/sing-crayon-shin-chan.gif" class="logo">
  <h5 class="mb-0">CloudVault</h5>
</div>

<div class="d-flex">
<aside class="sidebar">
  <strong>My Drive</strong>
  <hr>

  <small class="muted">Recipient email (OTP)</small>
  <input id="recipientEmail" class="form-control form-control-sm mt-1">

  <small class="muted mt-2 d-block">OTP</small>
  <input id="manualOtp" class="form-control form-control-sm mt-1" placeholder="Enter OTP">
</aside>

<main class="flex-grow-1 p-4">

<div class="card-panel">
<h5>Upload File</h5>

<input type="file" id="fileInput" class="form-control form-control-sm mb-2">
<input type="text" id="keyInput" class="form-control form-control-sm mb-2" placeholder="storage key (optional)">
<button id="uploadBtn" class="btn btn-sm" style="background:#1a73e8;color:#fff">Upload</button>

<div class="progress mt-3 d-none" id="progressWrap">
  <div class="progress-bar" id="progressBar"></div>
</div>

<div id="uploadMsg" class="small mt-2 muted"></div>
</div>

</main>
</div>

<script>
/* ================= CONFIG ================= */

const API_BASE = "http://localhost:8080";      // presign
const BACKEND_BASE = "http://localhost:3000"; // OTP backend

/* ================= ELEMENTS ================= */

const fileInput = document.getElementById("fileInput");
const keyInput = document.getElementById("keyInput");
const uploadBtn = document.getElementById("uploadBtn");
const uploadMsg = document.getElementById("uploadMsg");
const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");
const recipientEmail = document.getElementById("recipientEmail");
const manualOtp = document.getElementById("manualOtp");

/* ================= HELPERS ================= */

function setMessage(msg, ok=true){
  uploadMsg.textContent = msg;
  uploadMsg.style.color = ok ? "green" : "crimson";
}

function setProgress(p){
  progressWrap.classList.remove("d-none");
  progressBar.style.width = p + "%";
}

/* ================= OTP ================= */

async function sendOtp(email, key){
  const r = await fetch(BACKEND_BASE + "/send-otp", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ email, key })
  });
  return r.ok;
}

async function verifyOtp(otp, key){
  const r = await fetch(BACKEND_BASE + "/verify-otp", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ otp, key })
  });
  return r.ok;
}

/* ================= UPLOAD ================= */

uploadBtn.addEventListener("click", async ()=>{
  const file = fileInput.files[0];
  if(!file) return alert("Select a file");

  const key = keyInput.value.trim() || ("images/" + file.name);
  const email = recipientEmail.value.trim();
  const otp = manualOtp.value.trim();

  /* -------- OTP FLOW (FIXED) -------- */
  if(email){
    if(!otp){
      const sent = await sendOtp(email, key);
      if(!sent){
        setMessage("Failed to send OTP", false);
        return;
      }
      alert("OTP sent to " + email + ". Enter OTP and click Upload again.");
      return;
    }

    const verified = await verifyOtp(otp, key);
    if(!verified){
      setMessage("Invalid OTP", false);
      alert("OTP verification failed");
      return;
    }
  }

  /* -------- PRESIGN -------- */
  setMessage("Requesting upload URL...");
  setProgress(10);

  const presign = await fetch(API_BASE + "/presign", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ filename:file.name, contentType:file.type, key })
  });

  if(!presign.ok){
    setMessage("Presign failed", false);
    return;
  }

  const { url } = await presign.json();

  /* -------- UPLOAD TO S3 -------- */
  const xhr = new XMLHttpRequest();
  xhr.open("PUT", url);
  xhr.upload.onprogress = e=>{
    if(e.lengthComputable){
      setProgress(Math.round((e.loaded/e.total)*100));
    }
  };
  xhr.onload = ()=>{
    if(xhr.status===200){
      setMessage("Upload successful");
    }else{
      setMessage("Upload failed", false);
    }
  };
  xhr.onerror = ()=> setMessage("Network error", false);
  xhr.send(file);
});
</script>

</body>
</html>
